#!/usr/bin/env bash

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

indent() {
   sed -u 's/^/       /'
}

echo '     -> Running bin/compile.'
echo Current directory is `pwd` | indent
echo BUILD_DIR is $BUILD_DIR | indent
echo CACHE_DIR is $CACHE_DIR | indent
echo ENV_DIR is $ENV_DIR | indent

mkdir -p $CACHE_DIR

WINESRC=wine-1.6.2
if [ ! -e $CACHE_DIR/$WINESRC.tar.bz2 ]
then
   cd $CACHE_DIR
   curl -LO http://sourceforge.net/projects/wine/files/Source/$WINESRC.tar.bz2

# checksum?
fi

if [ ! -e $CACHE_DIR/$WINESRC ]
then
   bunzip2 < $WINESRC.tar.bz2 | tar xvf -
fi

cd $CACHE_DIR/$WINESRC

apt-get install flex
apt-get install wine


./configure --prefix=$BUILD_DIR/wine --enable-win64 \
             --without-alsa \
             --without-capi \
             --without-cms \
             --without-coreaudio \
             --without-cups \
             --without-curses \
             --without-dbus \
             --without-fontconfig \
             --without-freetype \
             --without-gphoto \
             --without-glu \
             --without-gnutls \
             --without-gsm \
             --without-gstreamer \
             --without-hal \
             --without-jpeg \
             --without-ldap \
             --without-mpg123 \
             --without-openal \
             --without-opencl \
             --without-opengl \
             --without-osmesa \
             --without-oss \
             --without-png \
             --without-sane \
             --without-tiff \
             --without-v4l \
             --without-xcomposite \
             --without-xcursor \
             --without-xinerama \
             --without-xinput \
             --without-xinput2 \
             --without-xml \
             --without-xrandr \
             --without-xrender \
             --without-xshape \
             --without-xshm \
             --without-xslt \
             --without-xxf86vm \
             --without-zlib  \
             --without-x;

make

export WINEARCH=win32
# /usr/local/bin/wineserver -p
# /usr/local/bin/wine cmd /c echo > /dev/null


